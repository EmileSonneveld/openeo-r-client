# POC: Use Case 1
# RClient -> GEE back-end
# v0.6.0
```{r}
library(openeo)
library(magrittr)
library(tibble)

user = "group8"
pwd = "test123"

# 1. Requesting the API versions available at the back-end
gee_host_url = "https://earthengine.openeo.org"
api_versions(gee_host_url)

gee = connect(host = gee_host_url, version="0.4.2",user = user,password = pwd,login_type = "basic")
# also inserting the direct link is possible
# gee = connect(host = "https://earthengine.openeo.org/v0.4",user = user,password = pwd)

```
# 2. Requesting the capabilities of the back-end
```{r}
capabilities(con = gee)
```
# 3. Check which collections are available at the back-end
```{r}
collections = list_collections(con = gee)
collections
```

# 4. Request details about a specific collection 
```{r}
collection_ids = lapply(collections$collections, function(coll) coll$id)
names(collection_ids) = collection_ids

describe_collection(con=gee,id = collection_ids$`COPERNICUS/S2`)
```

# 5. Check that needed processes are available
```{r}
list_processes(con = gee)
describe_process(con = gee, id = "reduce")
```

# 6. Request the supported secondary web service types
```{r}
 list_service_types(con = gee)
```

# 7. Create a WMS service (XYZ in this case)

```{r}
graph = process_graph_builder(con = gee)
data1 = graph$load_collection(id = graph$data$`COPERNICUS/S2`,
                              spatial_extent = list(west=-2.7634,south=43.0408,east=-1.121,north=43.8385),
                              temporal_extent = c("2018-04-30","2018-06-26"),
                              bands = c("B4","B8"))

b4 = graph$filter_bands(data = data1,bands = "B4")
b8 = graph$filter_bands(data=data1,bands = "B8")

ndvi = graph$normalized_difference(band1 = b4,band2 = b8)

reducer = graph$reduce(data = ndvi,dimension = "temporal", function(x) {
  min(x)
})

apply_linear_transform = graph$apply(data = reducer, process = function(value) {
  graph$linear_scale_range(x = cb2_graph$data$x, inputMin = -1, inputMax = 1,outputMin = 0,outputMax = 255)
})

final = graph$save_result(data = apply_linear_transform,format = "png") 

graph$setFinalNode(node = final)

graph
```

# client-sided validation
```{r}
graph$validate()

# server-sided validation
validate_process_graph(con = gee, graph=graph)
```


# 8. Webservice
# 8 a) create xyz service
```{r}
service_id = create_service(con = gee, 
                            type = "xyz",
                            graph = graph,
                            title = "UC1 service with R", 
                            description = "Created a XYZ service from R using the graph for Use Case 1 (NDVI calculation)")
service_id
```

# 8. b) request meta data
```{r}
list_services(con = gee)

service = describe_service(con=gee, id = service_id)
url = service$url
```

# 8. c) visualizing a xyz service with leaflet
```{r}
library(leaflet)
leaflet() %>% addTiles() %>% addTiles(url, tileOptions(tms=TRUE)) %>% setView(lng = -1.8,lat=43.4,zoom = 8)
```

# 8. d) remove service
```{r}
delete_service(con = gee,  id = service_id)
```

# 9. alternative download / processing 
# 9 a) direct computation
```{r}
library(sp)
library(raster)
compute_result(con = gee, graph=graph,format="png",output_file = "gee_test.png")
spplot(raster("gee_test.png"))
```

# 9.b) batch processing
```{r}
job_id =  create_job(con = gee, graph=graph,title="UC1 Rclient NDVI")
start_job(con = gee, job = job_id)
download_results(con=gee,job = job_id,folder = "./gee_test/")
delete_job(con = gee, job = job_id)
```
